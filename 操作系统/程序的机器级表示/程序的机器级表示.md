# 程序的机器级表示

### 描述

计算机执行机器代码，用字节序列编码低级的操作，包括**处理数据**，**管理内存**，**读写存储设备上的数据**，以及利用**网络通信**。

### 过程

编译器基于编程语言的规则，目标机器的**指令集**和操作系统遵循的惯例，最后生成机器代码

例如GCC，GCC语言编译器以汇编代码的形式输出，汇编代码是机器代码的**文本表示**，然后GCC驱动程序调用汇编器和链接器，根据汇编代码生成可执行的机器代码

### 为啥子汇编语言以及机器语言直接用的少

高级语言的**抽象程序较高**，更有效率，优化做的好的编译器是可以将效率和汇编相提并论的，且有检错功能

另外一个点就是汇编是与**机器硬件的指令集**相关的，而高级语言可以**跨平台移植**

### 机器语言

**IA32**(Intel Architecture 32-bit->Inter 32位体系结构)以及最新的Intel64，即IA32的64位扩展，也称**x86-64**，**此前的系列统称为x86**

### 程序编码

##### 处理过程（C语言）

1. gcc驱动程序驱动**C预处理器**`cpp`扩展源代码**，插入所有用**#include命令指定的文件**，并扩展所有**用#define声明指定的宏**

```C
#define dprint（expr） printf（#expr “ = %/n”，expr）
//使用语句 dprint（x/y）;
//调用宏时，该宏将被扩展为：printf（“x/y”“ = %/n”，x/y）;
```

2. gcc驱动程序驱动**C编译器**`ccl`输出汇编代码
3. gcc驱动程序驱动**汇编器**`as`将**可读的文本表示**的汇编代码转换成**二进制目标代码文件**`.o`，但是此时的目标文件存在所有指令的二进制表示，却没有全局值的地址
4. gcc驱动链接器`ld`把所有目标模块链接起来，并重定位地址，最后输出可执行代码文件

##### **机器级代码**

两种对于机器级编程很重要的**系统抽象**

1. 由指令集体结构或**指令集架构**(Instruction Set Architecture,ISA) 来定义机器级程序的格式和行为，它定义了**处理器状态**，**指令的格式**，以及每条指令对状态的影响。（人话就是：程序该如何与系统交互，**使用什么规范**）
2. 机器级程序使用的内存是**虚拟内存**，提供的内存模型看上去是一个非常大的字节数组。（人话就是：将内存分配抽象成简单的物件）

##### **处理器状态**

###### *程序计数器*

> *`pc`，在x86-64机器语言中用**%rip**表示，作用是给出将要**执行**的下一条**指令**在**内存的地址***

###### *整数寄存器*

> *包括**16**个命名的位置，分别存储**64位**的值*
>
> 1. *可以存储地址（指针）或整数数据*
> 2. *记录某些重要的程序状态*
> 3. *用来保存临时数据，比如过程的参数，局部变量以及函数的返回值*

###### *条件码寄存器*

> *保存着最近执行的算数或逻辑指令的状态信息*
>
> *用来实现控制数据流中的条件变化，比如说if while语句*

###### *一组向量寄存器*

> *一组向量寄存器可以存放一个或多个整数和浮点值*

##### 程序内存

程序内存包含：

1. 程序的可执行代码（.text 二进制指令）
2. 操作系统需要的一些信息
3. 用来管理过程调用和返回的运行时栈
4. 用户分配的内存块（比如new或者malloc分配的）

##### 有效虚拟地址

程序内存使用虚拟地址来寻址，只有有限的一部分虚拟地址被认为是合法的，例如：x86-64的虚拟地址是由64位的字来表示的，这些地址的**高16位必须设置为0**，所以能够指定的是2^48或64TB范围内的一个字节。

操作系统负责管理虚拟地址空间，将**虚拟地址翻译成**实际处理器内存中的**物理地址**。

##### 机器指令

机器指令只执行基本的操作

1. 将存放在寄存器的两个数字相
2. 加，在存储器和寄存器之间传送数据
3. 条件分支转移到新的指令地址

##### C语言联合汇编语言

1. 使用汇编语言编写完整的函数，然后单独保存到其他文件中，使用汇编器和链接器将其和C程序链接在一起
2. 使用GCC的**内联汇编**(inline assembly)特性，使用**asm**伪指令可以在C中包含**简短的汇编代码**，**减少了与机器相关的代码量**

### 数据格式

###### 字`word`

由于是从**16位**体系结构扩展**32位的**，Inter用术语"字`word`"表示16位数据类型，8位是字节`byte`，32位成为双字`double words`，64位是四字 `quad words`

###### **汇编代码后缀**

C语言： char->`b` short->`w` int->`l` long->`q` char*->`q`  float->`s` double->`l`

大多数的GCC生成的汇编代码指令都有一个字符的后缀，表名操作数的大小  传送字节`movb`  传送字`movw` 传送双子`movl` 传送四字`movq`

以及汇编代码使用`l`来表示4字节**整数**和8字节**双精度浮点数**，不会产生歧义，因为浮点数使用的是**一组完全不同的指令和寄存器** 

