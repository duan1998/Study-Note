# 第一章 网络游戏概述

### 多人游戏的简要历程

##### 1. 本地多人游戏

相比较单人游戏，典型差异是对多视点和多个输入设备的支持

##### 2. 早期网络多人游戏

串口：可实现两台计算机之间的通信，允许每次传输1比特的数据，其主要功能是与打印机，调制解调器等外部设备进行通信

使用串口进行通信，跨越多台个人计算机进行游戏会话，缺点是一台计算机最多只有两个串口，除非采用菊花链连接模式

最早的网络多人游戏运行在大型机组成的小网络中

##### 3. 多用户多人游戏

调制解调器：用于电话线进行通信，是调制器和解调器的简称

调制解调器为计算机提供通信工作流程：它可以 把计算机的数字信号翻译成可沿普通电话线传送的模拟信号，而这些模拟信号又可被线路另一端的另一个调制解调器接收，并译成计算机可懂的语言，完成通信

muti-user dungeon`MUD`，在个人计算机性能提升之后，硬件制造商就开始允许计算机之间使用调制解调器进行通信，虽然传输速率及其低，但是可以运行在除高校大型机之外的机器上

##### 4. 局域网游戏

局域网(local area network,NAT)是指在某一小区域内多台计算机的相互连接

局域网联机游戏聚会指的是由一群人聚在一个地方，以局域网连接各自的计算机，玩多人网络联机游戏

##### 5. 在线游戏

在线游戏(online game)中，玩家通过一些大型网络将地理位置上有一定距离的计算机彼此连接起来。尽管其实现方式和局域网类似，但是问题在于延迟，数据在网络上的传输时间

##### 6. 大规模多人在线游戏

拨号上网：使用电话线+调制解调器

massively multiplayer online game`MMO`,一些在互联网广泛使用之前的早期MMORPG，运行在拨号网络中

##### 7. 移动网络游戏

异步：不需要等待，等待被通知

许多多人游戏在移动平台上是异步的，移动平台的应用程序接口有用于异步通信的内置功能

随着wifi设备的普及和移动网路的发展，实时网络游戏可以运行在移动设备上

虽然，技术上异步网络游戏比实时网络游戏实现简单，但是没有后者可靠

### 游戏案例

##### 1. 星际围攻：部落

###### 	精巧设计

1. 数据分类

   > 创建网络游戏的首先是创建应用层协议，基于本游戏采用的是不可靠的传输层协议，对数据分类可以保证不必要的性能损失

   - 非保障数据：当宽带有限时，首先丢弃这些数据
   - 保障数据：需要保证其准确到达以及到达的顺序，比如标识玩家发起攻击的事件
   - 最近的状态数据：该类数据用于只有最新版本的数据才是重要数据的场合，比如一个特定玩家的生命值
   - 最快保障数据：具有最高的优先级，在可靠传输的基础上，保证尽快到达，比如玩家的移动信息

2. 客户端-服务器模型`client-server model`

   在C/S模型下，服务器只需处理O(n)量级的带宽，而另一中对等网络模型`peer-to-peer model`，则需要O(n<sup>2</sup>)的带宽

3. 网络实现上划分的层

   |                游戏模拟层                 |
   | :---------------------------------------: |
   | ghost管理器\|移动管理器\|事件管理器\|其他 |
   |                 流管理器                  |
   |                连接管理器                 |
   |              平台数据包模块               |

   - 平台数据包模块

     数据包是在网络中传输的有一定格式的数据集合。其是最底层，与平台相关，这一层是标准套接字API的封装，可以构建和发送不同的数据包格式，该游戏实现的是定制的可靠层，但是该可靠层不是在平台数据包模块中处理的，而是在上层如ghost管理器等

   - 连接管理器

     和传输层的作用相似，将连接底层抽象化，从上层流管理器接收数据，再传给底层平台数据包模块

     连接管理器层仍然是不可靠的，但是可以保证投递状态通知的正确传输，这样，上层就可以知道指定的数据是否被成功传输

     投递状态通知使用滑动窗口中接受域的位字段实现

   - 流管理器

     将数据发给连接管理器，其中重要的部分在于允许数据传输的最大速率，最大速率会根据网络连接质量而有所不同，以保证服务器不至于发送给客户端超出连接能力的数据，另一部分就是对于上层的管理器要发送的消息给定优先级

   - 事件管理器

     维持一个由游戏模拟层产生的事件队列，两个作用，首先是队列内事件的优先级，其余则是由于可以收到底层传来的是否被确认的flag，如果没有被确认，则把该事件重新放入队列中，重新传输一次，保证可靠传输

   - ghost管理器

     ghost管理器的任务是从服务器向客户端传输尽可能多的**相关对象**的状态

     ghost管理器保证**最近的数据**总是能成功的传输到所有的客户端

   - 移动管理器

     移动管理器的任务是尽快传输玩家的移动数据

##### 2. 帝国时代

###### 	精巧设计

 1. 确定性锁步网络模型`deterministic lockstep`

    这个模型中所有的计算机相互连接，即对等网络模型，每个节点都同时运行一个有保证的确定性模拟，锁步是因为节点之间使用通信机制来确保游戏过程中保持同步

	2. 同步命令

    当玩家可控的单元数增加时，即使每个单元发送很少的消息，依然很难保持同步

    同步命令的话，即使是专业的即时战略玩家，每分钟也不可能发送多余300条命令，相对比在几百个单元之间传输信息来说，对带宽的需求更加可控

    游戏的每一个实例需要独立执行每个玩家发出的命令，每个游戏实例需要与其他游戏实例保持同步

	3. 轮班计时器

    不同玩家运行游戏采用不同的帧速率，不同玩家的网络连接质量也不一样

    例子：玩家A发出攻击命令，但是需要等到B，C，D都准备好执行该命令后，A再执行命令，如果A等待执行攻击命令的时间过长，那么游戏看起来相当迟缓

    解决这个问题是引入轮班计时器，存在两点：

    1. 选择轮班的长度，《帝国时代》默认的时长是200ms，200ms内的所有命令存储再一个缓冲区内，当200ms结束后，缓冲区的所有命令将通过网络传输发送给其他玩家
    2. 两个轮班的执行延迟，*意思是例如一个玩家在50轮发出的命令直到52轮才被执行，在200ms轮班计时器的情况下，这意味着输入延迟，即从一个玩家发出命令到其作用在屏幕上，可能需要600ms，然而这两轮的宽限为其他玩家接收到确认某一轮的指令提供了充足的时间*（**个人对这段理解为：把网络延迟的原因以某种视角让玩家感受到这是输入延迟，并不是网络延迟**。）

	4. 基于网络情况动态调整渲染帧率（这个真的秀

    一帧就那么点时间，减少渲染的时间可以为网络数据接收分配更多的时间

	5. 同步

    当随机地图刚刚创建的时候，一个鹿的方位有轻微偏离，其觅食路径也有细微差别，几分钟之后，一个猎鹿的村民也会轻微偏离方向，也可能因此一无所获到家中

    解决这个问题办法是伪随机数，大家都用同一个随机种子，这样就完事了







### 总结

这一章的话大部分时间是在阐述发展史，以及某个时期特定游戏开创性的物件，物件大部分都是几笔带过，部分理解需要结合谷歌，期待下一章

