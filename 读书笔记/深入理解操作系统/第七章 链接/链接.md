# 链接

## 前置知识

### 目标文件

### 可重定位目标文件

### 符号和符号表

### 可执行目标文件

### 加载可执行目标文件

## 链接

1. 链接`linking`是将各种代码和数据片段收集并组合成为一个单一文件的过程，通过链接器。链接可执行于编译时`compile time`，加载时`load time`，运行时`run time`

2. 为了能够分离编译`separate compliation`大的源文件，独立的修改和编译其子模块，并重新链接

3. C语言中`gcc`编译器驱动程序，命令步骤为 main.c-->C预处理器`cpp`-->`main.i`(`ASCII code file`)-->C编译器`ccl`-->`main.s`(`ASCII code file`)-->汇编器`as`-->`main.o`(`recatable oject file`可重定位目标文件)-->链接器`ld`-->`prog`(`executable object file`可执行目标文件)

4. ```shell
   linux> ./prog   //shell调用os中的加载器函数，将文件中的代码和数据复制到内存中，然后   把控制转移到这个程序的开头
   ```

### 符号解析

##### 链接器如何解析多重定义的全局符号

##### 与静态库链接

##### 链接器如何使用静态库来解析引用

### 重定位

1. 将每个符号引用和对应的符号表`.symbol`中的符号定义相关联，这样就可以知道了符号的类型，就可以知道它的输入模块中的代码节和数据节的大小，重定位时，将**合并输入模块，并为每个符号分配运行时地址**

2. **合并**

   1. 链接器将输入模块中所有相同类型的节比如.data，合并成**可执行目标文件**的.data节

   2. 链接器将运行时内存地址赋给新的**聚合节**，赋给输入模块中的**非聚合节**，以及赋给输入模块**定义的每个符号**，这下完成后，程序中的**每条指令和全局变量**都有唯一的**运行时内存地址**了

3. 重定位节中的符号引用（修改下数据节和代码节中的符号引用地址）

   1. 链接器修改代码节和数据节中对每个**符号**的**引用**，使得它们指向正确的**运行时地址**

#### 重定位条目

1. 当汇编器生成一个目标模块时，其并不晓得数据和代码**最终**放在内存中什么位置，也不晓得这个模块**引用的任何外部定义的函数或者全局变量的位置**，那就会生成一个**重定位条目**，告诉**链接器**在**目标文件合并时**如何**修改**这个**引用**
2. **代码**的重定位条目放在`.rel.text`中，**已初始化数据**的重定位条目放在`.rel.data`中
3. **条目指明了如何去计算被修改的引用地址**    因为有可能这个位置是相对当前**程序计算器（PC，指向下一条指令的地址）**一定偏移的，也有可能是个绝对地址
4. 举例重定位类型
   1. R_X86_64_PC32 重定位一个使用32位PC相对地址的引用，当cpu执行到一条使用PC相对寻址的指令时，就把指令中编码的32位值加上PC的当前运行时值，得到有效地址
   2. R_X86_64_32 重定位一个使用32位绝对地址的引用，cpu直接使用在指令中编码的32位值作为有效地址

#### 重定位符号引用

##### 重定位PC相对引用 



##### 重定位绝对引用

## 静态链接

1. 静态链接器`static linker`以一组可重定位目标文件和命令行参数作为输入，生成一个完全链接的，可以加载和运行的可执行目标文件作为输出
2. 输入的可重定位目标文件由**各种不同的代码和数据节`section`组成**，**每一节**都是一个**连续的字节序列**

## 共享库的动态链接

1. 共享库`shared library`是一个目标模块。在运行或加载时，可以加载到任意的内存地址，并和一个在内存中的程序链接起来，这个过程被称为动态链接`dynamic linking`，由名叫动态链接器`dynamic linker`的程序完成
2. **在linux中，共享库被称为共享目标`shared object`即`so`，在微软的操作系统中成为动态链接库`dll`**
3. 共享库可以解决静态链接时一些例如标准I/O的函数会被复制到每个运行进程的文本段`.text`中，如果有上百个，就是浪费
4. 共享库的共享方式
   1. 所有引用该库的可执行目标文件共享这个共享库的**代码和数据**，而不是像静态库那样复制并嵌入到引用它的可执行目标文件中（独此一份
   2. 在内存中，一个共享库的**.text节**的一个副本可以被不同的正在运行的进程共享（估计数据还是不能共享

### 加载时

1. 基本思路是当创建可执行文件时，静态执行部分链接（**重定位和符号表信息**），然后在程序加载时，动态完成链接过程（**代码和数据**）
2.  

### 运行时

## 